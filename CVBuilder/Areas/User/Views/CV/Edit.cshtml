@model CVBuilder.Areas.User.ViewModels.CV.NewCVRequest

@{
    Layout = "_CreateCVLayout";
    ViewData["Title"] = "Edit";
}

@section Header {
  <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
  <style>

        #iframe-container {
            width: max-content;
            transform: scale(0.5);
            transform-origin: top;
        }

        #cv-frame {   
            width: 210mm;
            height: 297mm;
            transform-origin: top center;
            box-shadow: rgba(100, 100, 111, 0.2) 0px 7px 29px 0px;
        }

        #preview-pane {
            overflow-y: auto;
            overflow-x: hidden;
        }
        
  </style>
}

@section Scripts {
    <script>

        const htmlString = `
            @Html.Raw(ViewBag.Template?.HtmlContent ?? "")
        `;

        const sectionsBig = JSON.parse('@Html.Raw(Model.Sections)');

        function cvWizard() {
            return {
                html: htmlString,
                step: 1,
                profile: {
                    "name": "@Model.FullName",
                    "role": "@Model.Title",
                    "contact": {
                        "email": "@Model.Email",
                        "phone": "@Model.Phone",
                        "website": "",
                        "address": "@Model.Address"
                    },
                    "side-sections": sectionsBig['side-sections'],
                     sections: sectionsBig['sections']
                },
                templateId: @(ViewBag.TemplateId ?? 0),
                fileName: "@Model.FileName",
                themeColor: "@Model.ThemeColor",
                timer: null,

                changed() {
                    clearTimeout(this.timer);
                    this.timer = setTimeout(() => this.run(), 3000);
                },

                run() {
                    const html = htmlCompiled(this.html, this.profile);
                    const blob = new Blob([html], { type: "text/html" });
                    const url = URL.createObjectURL(blob);

                    this.$refs.frame.src = url;
                },

                addSideSection(title, subsections) {
                    this.profile["side-sections"].push({ title, subsections });
                },
                addSection(title, subsections) {
                    this.profile.sections.push({ title, subsections });
                },

                init() {
                    this.run();
                     this.$watch('profile', () => {
                         this.changed();
                     });
                }
            };
        }

        function dataSection() {
            return { 
                selected: '', 
                title: '', 
                subsections: [],
                subsection: { title: '', date: '', items: [], text: ''},

                addSubsection() {
                    let sec = {};

                    switch(this.selected) {
                        case "text":
                           sec.text = this.subsection.text;
                           break;
                        case "items":
                           sec.items = this.subsection.items;
                           break;
                        case "subsection":
                           sec.title = this.subsection.title;
                           sec.date = this.subsection.date;
                           sec.text = this.subsection.text;
                           sec.items = section.items;
                           break;
                    };
                    this.subsections.push(sec);

                    this.selected = '';
                    this.subsection = { title: '', date: '', items: [], text: ''}

                },

                resetSection() {
                    this.title = '';
                    this.subsections = [];
                }
            }
        }

function htmlCompiled(template, data) {
    let templater = Handlebars.compile(template);
    return templater(data);
}

    </script>
    <script>
       
        function scaleCV() {
            const frameContainer = $("#iframe-container").get(0);
            const previewPane = $("#preview-pane").get(0);
            const widthPreviewPane = previewPane.clientWidth;
            const scale = (widthPreviewPane / 793) * 0.75;  
            frameContainer.style.transform = `scale(${scale})`;
        }

        window.addEventListener("resize", scaleCV);
        window.addEventListener("load", scaleCV);
  </script>
}


<section x-data="cvWizard()">
    <div class="progress mb-4">
        <div class="progress-bar" role="progressbar" :style="'width:' + (step * 20) + '%'"></div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <section x-show="step === 1">
                <h4>Thông tin chung</h4>

                <div class="mb-3">
                    <label>Full Name</label>
                    <input class="form-control" x-model="profile.name">
                </div>

                <div class="mb-3">
                    <label>Title</label>
                    <input class="form-control" x-model="profile.role">
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label>Email</label>
                        <input class="form-control" x-model="profile.contact.email">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label>Phone</label>
                        <input class="form-control" x-model="profile.contact.phone">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label>Address</label>
                        <input class="form-control" x-model="profile.contact.address">
                    </div>
                </div>

                <button class="btn btn-primary" @@click="step = 2">Next</button>
            </section>
            <section x-show="step === 2">
                <h4>Thanh bên</h4>
                <template x-for="(sec, i) in profile['side-sections']" :key="i">
                    <div class="card p-3 mb-2">
                        <input class="form-control mb-2" placeholder="Section Title"
                               x-model="sec.title">
                         
                               <template x-for="(item, i) in sec.subsections" :accesskey="i" >
                                   <div>
                                    <label>Email</label>
                                    <input class="form-control" x-model="profile.contact.email">
                                    <h4 x-show="item.title != ''" x-text="item.title"></h4>
                                    <p x-show="item.date != ''" x-text="item.date"></p>
                                    <p x-show="item.text != ''" x-text="item.text"></p>
                                    <ul>
                                       <template x-for="(im, i) in item.items" :accesskey="i">
                                            <li x-text="im"></li>
                                       </template>
                                   </ul>
                                   </div>
                               </template>
                        <button class="btn btn-danger mt-2" @@click="profile['side-sections'].splice(i,1)">Delete</button>
                    </div>
                </template>
                <div x-data="dataSection()">
                    <div class="mt-4 p-4 border rounded">
                        <input class="form-control mb-2" placeholder="Section Title"
                               x-model="title">
                        <template x-for="item in subsections">
                            <div>
                                <h4 x-show="item.title != ''" x-text="item.title"></h4>
                                <p x-show="item.date != ''" x-text="item.date"></p>
                                <p x-show="item.text != ''" x-text="item.text"></p>
                                <ul>
                                    <template x-for="im in item.items">
                                        <li x-text="im"></li>
                                    </template>
                                </ul>
                            </div>
                        </template>
                    <select x-model="selected" class="border p-2 rounded">
                        <option value="">-- Select Section --</option>
                        <option value="text">Văn bản</option>
                        <option value="items">Danh sách</option>
                        <option value="subsection">Mục phụ</option>
                    </select>
                        <div x-show="selected === 'text'">
                            <textarea x-model="subsection.text" ></textarea>
                        </div>

                        <div x-show="selected === 'items'">
                             <template x-for="(item, i) in subsection.items" :key="i">
                                <input x-model="subsection.items[i]" />
                             </template>
                        <button class="btn btn-secondary" @@click="subsection.items.push('')">
                            + Thêm 
                        </button>
                        </div>

                        <div x-show="selected === 'subsection'">
                            <input class="form-control mb-2" placeholder="Section Title"
                                       x-model="subsection.title">
                            <input class="form-control mb-2" placeholder="Date" x-model="subsection.date"/>
                            <textarea x-model="subsection.text" ></textarea>
                             <template x-for="(item, i) in subsection.items" :key="i">
                                 <input x-model="item" />
                             </template>
                        <button class="btn btn-secondary" @@click="subsection.items.push('')">
                            + Thêm 
                        </button>
                        </div>

                        <div x-show="selected === ''">
                            <p class="text-gray-500">Xin hãy chọn loại mục phụ...</p>
                        </div>

                    <button x-on:click="addSubsection()">Thêm mục phụ</button>
                    </div>
                    <button x-on:click="addSideSection(title, subsections);resetSection()">Thêm mục</button>
                </div>
                <div class="mt-3">
                    <button class="btn btn-secondary" @@click="step = 1">Back</button>
                    <button class="btn btn-primary" @@click="step = 3">Next</button>
                </div>
            </section>

            <section x-show="step === 3">
                <h4>Trang chính</h4>
                <template x-for="(sec, i) in profile.sections" :key="i">
                    <div class="card p-3 mb-2">
                        <input class="form-control mb-2" placeholder="Section Title"
                               x-model="sec.title">
                         
                               <template x-for="(item, i) in sec.subsections" :accesskey="i" >
                                   <div>
                                    <h4 x-show="item.title != ''" x-text="item.title"></h4>
                                    <p x-show="item.date != ''" x-text="item.date"></p>
                                    <p x-show="item.text != ''" x-text="item.text"></p>
                                    <ul>
                                       <template x-for="(im, i) in item.items" :accesskey="i">
                                            <li x-text="im"></li>
                                       </template>
                                   </ul>
                                   </div>
                               </template>
                        <button class="btn btn-danger mt-2" @@click="profile.sections.splice(i,1)">Delete</button>
                    </div>
                </template>
                <div x-data="dataSection()">
                    <div class="mt-4 p-4 border rounded">
                        <input class="form-control mb-2" placeholder="Section Title"
                               x-model="title">
                        <template x-for="item in subsections">
                            <div>
                                <h4 x-show="item.title != ''" x-text="item.title"></h4>
                                <p x-show="item.date != ''" x-text="item.date"></p>
                                <p x-show="item.text != ''" x-text="item.text"></p>
                                <ul>
                                    <template x-for="im in item.items">
                                        <li x-text="im"></li>
                                    </template>
                                </ul>
                            </div>
                        </template>
                    <select x-model="selected" class="border p-2 rounded">
                        <option value="">-- Select Section --</option>
                        <option value="text">Văn bản</option>
                        <option value="items">Danh sách</option>
                        <option value="subsection">Mục phụ</option>
                    </select>
                        <div x-show="selected === 'text'">
                            <textarea x-model="subsection.text" ></textarea>
                        </div>

                        <div x-show="selected === 'items'">
                             <template x-for="(item, i) in subsection.items" :key="i">
                                <input x-model="subsection.items[i]" />
                             </template>
                        <button class="btn btn-secondary" @@click="subsection.items.push('')">
                            + Thêm 
                        </button>
                        </div>

                        <div x-show="selected === 'subsection'">
                            <input class="form-control mb-2" placeholder="Section Title"
                                       x-model="subsection.title">
                            <input class="form-control mb-2" placeholder="Date" x-model="subsection.date"/>
                            <textarea x-model="subsection.text" ></textarea>
                             <template x-for="(item, i) in subsection.items" :key="i">
                                 <input x-model="item" />
                             </template>
                        <button class="btn btn-secondary" @@click="subsection.items.push('')">
                            + Thêm 
                        </button>
                        </div>

                        <div x-show="selected === ''">
                            <p class="text-gray-500">Xin hãy chọn loại mục phụ...</p>
                        </div>

                    <button x-on:click="addSubsection()">Thêm mục phụ</button>
                    </div>
                    <button x-on:click="addSection(title, subsections);resetSection()">Thêm mục</button>
                </div>
                <div class="mt-3">
                    <button class="btn btn-secondary" @@click="step = 2">Back</button>
                    <button class="btn btn-primary" @@click="step = 4">Next</button>
                </div>
            </section>

            <section x-show="step === 4">
                <h4>Hoàn tất</h4>

                <div class="mb-3">
                    <label>File Name</label>
                    <input class="form-control" x-model="fileName">
                </div>

                <div class="mb-3">
                    <label>Theme Color</label>
                    <input type="color" class="form-control form-control-color"
                           x-model="themeColor">
                </div>

                <!-- Form Submit -->
                <form method="post" asp-action="Edit">
                    @Html.AntiForgeryToken()

                    <input type="hidden" name="Id" value="@Model.Id">
                    <input type="hidden" name="TemplateId" :value="templateId">
                    <input type="hidden" name="FileName" :value="fileName">
                    <input type="hidden" name="ThemeColor" :value="themeColor">

                    <input name="FullName" type="hidden" :value="profile.name" />
                    <input name="Title"  type="hidden" :value="profile.role" />
                    <input name="Email"  type="hidden" :value="profile.contact.email" />
                    <input name="Phone" type="hidden" :value="profile.contact.phone" />
                    <input name="Address" type="hidden" :value="profile.contact.address" />
                    <input name="Sections" type="hidden" :value="JSON.stringify({ sections: profile.sections, 'side-sections': profile['side-sections']})" />

                    <button class="btn btn-secondary" type="button" @@click="step = 3">Back</button>
                    <button class="btn btn-success" type="submit">Cập nhật CV</button>
                </form>
            </section>
        </div>
        <div id="cv-container" class="col-md-6 border p-2 d-flex flex-column" style="height: 750px;">
                <div class="text-xs opacity-70 mb-1">Preview</div>
                <div class="d-flex justify-content-center" id="preview-pane">
                    <div id="iframe-container">
                        <iframe x-ref="frame" id="cv-frame" class="bg-white"></iframe>
                    </div>
                </div>
        </div>
</div>
</section>




